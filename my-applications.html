<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grant Submission - Globuk</title>
  <link rel="stylesheet" href="dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* Multi-step form styling */
    .form-step { display: none; }
    .form-step.active { display: block; }
    .form-navigation { margin-top: 20px; display: flex; justify-content: space-between; }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin: 5px 0;
      border-radius: 6px; border: 1px solid #ccc; font-size: 16px;
    }
    button {
      cursor: pointer; background-color: #4A90E2; color: white; border: none;
      transition: all 0.2s ease;
    }
    button:hover { background-color: #357ABD; }
    small { display: block; margin-bottom: 10px; color: #555; }

    /* Error message */
    .error-message {
      color: #e74c3c;
      font-size: 14px;
      margin-top: -5px;
      margin-bottom: 10px;
      display: none;
    }

    /* Shake animation */
    .shake {
      animation: shake 0.3s ease;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
    }
  </style>
</head>
<body>
  <main class="main-content">
    <header class="main-header">
      <h1>Grant Appeal Application</h1>
      <p>Please complete all steps to submit your application.</p>
    </header>

    <form id="grantForm">
      <!-- Step 1: Name -->
      <div class="form-step active">
        <label for="fullName">Full Name</label>
        <input type="text" id="fullName" name="fullName" placeholder="John Doe" required>
        <small>Enter your first and last name.</small>
        <div class="form-navigation">
          <div></div>
          <button type="button" class="next-btn">Next</button>
        </div>
      </div>

      <!-- Step 2: Sector -->
      <div class="form-step">
        <label for="sector">Occupation Sector</label>
        <select id="sector" name="sector" required>
          <option value="">Select sector</option>
          <option value="Agriculture">Agriculture</option>
          <option value="Education">Education</option>
          <option value="Technology">Technology</option>
          <option value="Health">Health</option>
          <option value="Services">Services</option>
          <option value="Other">Other</option>
        </select>
        <small>Select the primary sector your occupation/business is in.</small>
        <div class="form-navigation">
          <button type="button" class="prev-btn">Previous</button>
          <button type="button" class="next-btn">Next</button>
        </div>
      </div>

      <!-- Step 3: Occupation -->
      <div class="form-step">
        <label for="occupation">Your Occupation</label>
        <input type="text" id="occupation" name="occupation" placeholder="e.g. Software Developer" required>
        <small>Describe your occupation or business.</small>
        <div class="form-navigation">
          <button type="button" class="prev-btn">Previous</button>
          <button type="button" class="next-btn">Next</button>
        </div>
      </div>

      <!-- Step 4: Employees -->
      <div class="form-step">
        <label for="employees">Number of Employees</label>
        <select id="employees" name="employees" required>
          <option value="">Select</option>
          <option value="1-5">1-5</option>
          <option value="6-10">6-10</option>
          <option value="11-20">11-20</option>
          <option value="21-50">21-50</option>
          <option value="51+">51+</option>
        </select>
        <small>How many employees are currently in your business?</small>
        <div class="form-navigation">
          <button type="button" class="prev-btn">Previous</button>
          <button type="button" class="next-btn">Next</button>
        </div>
      </div>

      <!-- Step 5: Position -->
      <div class="form-step">
        <label for="position">Your Position</label>
        <select id="position" name="position" required>
          <option value="">Select</option>
          <option value="Owner">Owner</option>
          <option value="Manager">Manager</option>
          <option value="Employee">Employee</option>
          <option value="Other">Other</option>
        </select>
        <small>Your role in the business or occupation.</small>
        <div class="form-navigation">
          <button type="button" class="prev-btn">Previous</button>
          <button type="button" class="next-btn">Next</button>
        </div>
      </div>

      <!-- Step 6: Grant Amount -->
      <div class="form-step">
        <label for="amount">Requested Grant Amount (£)</label>
        <input type="number" id="amount" name="amount" placeholder="£0.00" required max="15000">
        <small>Maximum grant allowed is <strong>£15,000</strong>.</small>
        <p class="error-message" id="amountError">You cannot request more than £15,000.</p>
        <div class="form-navigation">
          <button type="button" class="prev-btn">Previous</button>
          <button type="button" class="next-btn" id="amountNext">Next</button>
        </div>
      </div>

      <!-- Step 7: Bank Details -->
      <div class="form-step">
        <label for="bankName">Bank Name</label>
        <input type="text" id="bankName" name="bankName" placeholder="Bank of Example" required>
        <label for="bankNumber">Bank Account Number</label>
        <input type="text" id="bankNumber" name="bankNumber" placeholder="1234567890" required>
        <small>Provide your bank details to receive the grant.</small>
        <div class="form-navigation">
          <button type="button" class="prev-btn">Previous</button>
          <button type="button" class="next-btn">Next</button>
        </div>
      </div>

      <!-- Step 8: Reason -->
      <div class="form-step">
        <label for="reason">Why should we give you this grant?</label>
        <textarea id="reason" name="reason" rows="4" placeholder="Explain why your application deserves the grant" required></textarea>
        <small>Explain why your business or occupation deserves the grant.</small>
        <div class="form-navigation">
          <button type="button" class="prev-btn">Previous</button>
          <button type="submit">Submit Application</button>
        </div>
      </div>
    </form>
  </main>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const grantForm = document.getElementById('grantForm');
    const formSteps = document.querySelectorAll('.form-step');
    const amountInput = document.getElementById('amount');
    const amountNextBtn = document.getElementById('amountNext');
    const amountError = document.getElementById('amountError');
    let currentStep = 0;

    function showStep(step) {
      formSteps.forEach((s, i) => s.classList.toggle('active', i === step));
    }

    // Normal next and previous
    document.querySelectorAll('.next-btn').forEach(btn => {
      if (btn.id !== 'amountNext') {
        btn.addEventListener('click', () => {
          if (currentStep < formSteps.length - 1) {
            currentStep++;
            showStep(currentStep);
          }
        });
      }
    });

    document.querySelectorAll('.prev-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (currentStep > 0) {
          currentStep--;
          showStep(currentStep);
        }
      });
    });

    // Amount validation (don't go next if > 15k)
    amountNextBtn.addEventListener('click', () => {
      const amount = parseFloat(amountInput.value);
      if (isNaN(amount) || amount <= 0) {
        amountError.textContent = "Please enter a valid amount.";
        amountError.style.display = "block";
        amountNextBtn.classList.add("shake");
        setTimeout(() => amountNextBtn.classList.remove("shake"), 300);
        return;
      }

      if (amount > 15000) {
        amountError.textContent = "You cannot request more than £15,000.";
        amountError.style.display = "block";
        amountNextBtn.classList.add("shake");
        setTimeout(() => amountNextBtn.classList.remove("shake"), 300);
        return;
      }

      // Valid: go next
      amountError.style.display = "none";
      currentStep++;
      showStep(currentStep);
    });

    // Submit form
    grantForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(grantForm);
      const amount = parseFloat(formData.get('amount'));
      if (amount > 15000) {
        amountError.textContent = "You cannot request more than £15,000.";
        amountError.style.display = "block";
        return;
      }

      const data = {
        uid: auth.currentUser.uid,
        fullName: formData.get('fullName'),
        sector: formData.get('sector'),
        occupation: formData.get('occupation'),
        employees: formData.get('employees'),
        position: formData.get('position'),
        amount: amount,
        bankName: formData.get('bankName'),
        bankNumber: formData.get('bankNumber'),
        reason: formData.get('reason'),
        status: 'Pending',
        createdAt: serverTimestamp()
      };

      try {
        await addDoc(collection(db, 'grants'), data);
alert('Grant application submitted successfully!');
window.location.href = "dashboard.html";
      } catch (error) {
        console.error(error);
        alert('Error submitting grant application: ' + error.message);
      }
    });

    // Ensure user is logged in
    await setDoc(doc(db, "applications", appId), {
  ...applicationData,
  status: "pending",
  createdAt: new Date().toISOString(),
});

// Redirect after successful submission
window.location.href = "dashboard.html";
  </script>
</body>
</html>